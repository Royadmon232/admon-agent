Starting test execution...
Node version:
v22.15.0
NPM version:
10.9.2

=== Running ESLint ===

> insurance-whatsapp-bot@1.0.0 lint
> eslint . --fix


/Users/royadmon1/Documents/insurance_whatsapBot/index.js
    6:3   error  'sendWhatsAppMessageWithButton' is defined but never used                 no-unused-vars
    7:3   error  'logDelivery' is defined but never used                                   no-unused-vars
   54:7   error  'WHATSAPP_API_TOKEN' is assigned a value but never used                   no-unused-vars
   55:7   error  'WHATSAPP_PHONE_NUMBER_ID' is assigned a value but never used             no-unused-vars
   75:7   error  'KNOWLEDGE' is assigned a value but never used                            no-unused-vars
  418:47  error  'memory' is defined but never used. Allowed unused args must match /^_/u  no-unused-vars
  421:32  error  'extractCustomerInfo' is not defined                                      no-undef
  538:15  error  'phone_number_id' is assigned a value but never used                      no-unused-vars

/Users/royadmon1/Documents/insurance_whatsapBot/scripts/generateEmbeddings.js
  13:7  error  'EMBEDDING_VECTOR_DIMENSION' is assigned a value but never used  no-unused-vars

/Users/royadmon1/Documents/insurance_whatsapBot/server.js
   1:1   error  'app' is not defined                    no-undef
  24:11  error  'handleIncomingMessage' is not defined  no-undef
  35:1   error  'app' is not defined                    no-undef
  42:1   error  'app' is not defined                    no-undef
  62:1   error  'app' is not defined                    no-undef

/Users/royadmon1/Documents/insurance_whatsapBot/services/memoryService.js
  140:19  error  Do not access Object.prototype method 'hasOwnProperty' from target object  no-prototype-builtins

/Users/royadmon1/Documents/insurance_whatsapBot/services/ragChain.js
    5:10  error  'PromptTemplate' is defined but never used           no-unused-vars
    5:46  error  'MessagesPlaceholder' is defined but never used      no-unused-vars
    6:24  error  'AIMessage' is defined but never used                no-unused-vars
   14:25  error  'resolve' is defined but never used                  no-unused-vars
   19:7   error  '__dirname' is assigned a value but never used       no-unused-vars
   31:3   error  'salesTemplates' is assigned a value but never used  no-unused-vars
   72:5   error  'chain' is assigned a value but never used           no-unused-vars
  224:16  error  'mergeAnswersWithGPT' is defined but never used      no-unused-vars

/Users/royadmon1/Documents/insurance_whatsapBot/services/salesTemplates.js
  1:53  error  Parsing error: Unexpected token with

/Users/royadmon1/Documents/insurance_whatsapBot/services/vectorSearch.js
  186:24  error  'searchWithScore' is not defined  no-undef
  199:31  error  'searchWithScore' is not defined  no-undef

/Users/royadmon1/Documents/insurance_whatsapBot/services/whatsappService.js
    1:10  error  'normalize' is defined but never used                                            no-unused-vars
    2:10  error  'createRetrievalChain' is defined but never used                                 no-unused-vars
    3:10  error  'smartAnswer' is defined but never used                                          no-unused-vars
    4:10  error  'intentDetect' is defined but never used                                         no-unused-vars
    4:24  error  'buildSalesResponse' is defined but never used                                   no-unused-vars
   20:7   error  'queue' is assigned a value but never used                                       no-unused-vars
   90:24  error  'client' is defined but never used. Allowed unused args must match /^_/u         no-unused-vars
  102:37  error  'imageBuffer' is defined but never used. Allowed unused args must match /^_/u    no-unused-vars
  136:11  error  'history' is assigned a value but never used                                     no-unused-vars
  139:28  error  'handleMessage' is not defined                                                   no-undef
  154:16  error  'handleTextMessage' is defined but never used                                    no-unused-vars
  157:9   error  'messageId' is assigned a value but never used                                   no-unused-vars
  171:9   error  'history' is assigned a value but never used                                     no-unused-vars
  174:26  error  'handleMessage' is not defined                                                   no-undef
  186:16  error  'handleImageMessage' is defined but never used                                   no-unused-vars
  210:28  error  'handleMessage' is not defined                                                   no-undef
  254:27  error  'prisma' is not defined                                                          no-undef
  280:11  error  'prisma' is not defined                                                          no-undef
  416:27  error  'getHistory' is not defined                                                      no-undef
  540:11  error  'result' is assigned a value but never used                                      no-unused-vars
  576:79  error  'buttonPayload' is defined but never used. Allowed unused args must match /^_/u  no-unused-vars

/Users/royadmon1/Documents/insurance_whatsapBot/src/agentController.js
    2:8   error  'axios' is defined but never used                                                no-unused-vars
   12:7   error  'EMB_MODEL' is assigned a value but never used                                   no-unused-vars
   14:7   error  'PRIMARY_MODEL' is assigned a value but never used                               no-unused-vars
   15:7   error  'FALLBACK_MODEL' is assigned a value but never used                              no-unused-vars
  182:10  error  'findSimilarPreviousQuestion' is defined but never used                          no-unused-vars
  232:79  error  'buttonPayload' is defined but never used. Allowed unused args must match /^_/u  no-unused-vars

/Users/royadmon1/Documents/insurance_whatsapBot/test_twilio_limit.js
  5:7  error  'originalTwilio' is assigned a value but never used  no-unused-vars
  8:7  error  'mockClient' is assigned a value but never used      no-unused-vars

/Users/royadmon1/Documents/insurance_whatsapBot/utils/dbUtils.js
  1:8  error  'pool' is defined but never used  no-unused-vars

/Users/royadmon1/Documents/insurance_whatsapBot/utils/normalize.js
  2:8  error  'removeAccents' is defined but never used                  no-unused-vars
  5:7  error  'HEBREW_FINAL_LETTERS' is assigned a value but never used  no-unused-vars

/Users/royadmon1/Documents/insurance_whatsapBot/utils/send.js
  23:42  error  'buttons' is assigned a value but never used  no-unused-vars

/Users/royadmon1/Documents/insurance_whatsapBot/utils/splitQuestions.js
  58:36  error  Unnecessary escape character: \.  no-useless-escape
  58:38  error  Unnecessary escape character: \)  no-useless-escape

✖ 61 problems (61 errors, 0 warnings)

Lint exit code: 1

=== Running Tests ===

> insurance-whatsapp-bot@1.0.0 test
> NODE_OPTIONS=--experimental-vm-modules jest

(node:20175) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/salesTemplates.test.js
  ● salesTemplates › intentDetect › should detect price_pushback intent when text contains "יקר"

    expect(received).toBe(expected) // Object.is equality

    Expected: "frustration"
    Received: "price_pushback"

      11 |
      12 |       testCases.forEach(text => {
    > 13 |         expect(intentDetect(text)).toBe('frustration');
         |                                    ^
      14 |       });
      15 |     });
      16 |   });

      at tests/salesTemplates.test.js:13:36
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (tests/salesTemplates.test.js:12:17)

  ● salesTemplates › buildSalesResponse › should return non-empty string for each intent

    expect(received).toBeTruthy()

    Received: ""

      28 |       intents.forEach(intent => {
      29 |         const response = buildSalesResponse(intent, mockMemory);
    > 30 |         expect(response).toBeTruthy();
         |                          ^
      31 |         expect(typeof response).toBe('string');
      32 |         expect(response.length).toBeGreaterThan(0);
      33 |       });

      at tests/salesTemplates.test.js:30:26
          at Array.forEach (<anonymous>)
      at Object.<anonymous> (tests/salesTemplates.test.js:28:15)

(node:20174) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/memoryService.test.js
  ● Console

    console.log
      [memoryService] ℹ️  No valid updates to apply

      at updateCustomer (services/memoryService.js:166:15)

  ● Memory Service › remember() › should insert customer and memory record

    AggregateError:

      107 |   try {
      108 |     // Ensure customer exists first
    > 109 |     await pool.query(
          |     ^
      110 |       'INSERT INTO customers (phone) VALUES ($1) ON CONFLICT (phone) DO NOTHING',
      111 |       [phone]
      112 |     );

      at node_modules/pg-pool/index.js:45:11
      at remember (services/memoryService.js:109:5)
      at Object.<anonymous> (tests/memoryService.test.js:32:7)

  ● Memory Service › remember() › should handle errors gracefully

    TypeError: mockPool.query.mockRejectedValueOnce is not a function

      47 |     it('should handle errors gracefully', async () => {
      48 |       const error = new Error('DB error');
    > 49 |       mockPool.query.mockRejectedValueOnce(error);
         |                      ^
      50 |
      51 |       await expect(remember('+972501234567', 'key', 'value'))
      52 |         .rejects.toThrow('DB error');

      at Object.<anonymous> (tests/memoryService.test.js:49:22)

  ● Memory Service › recall() › should return memory object with latest values

    TypeError: mockPool.query.mockResolvedValueOnce is not a function

      63 |       ];
      64 |
    > 65 |       mockPool.query.mockResolvedValueOnce({ rows: mockRows });
         |                      ^
      66 |
      67 |       const memory = await recall(phone);
      68 |

      at Object.<anonymous> (tests/memoryService.test.js:65:22)

  ● Memory Service › recall() › should return empty object on error

    TypeError: mockPool.query.mockRejectedValueOnce is not a function

      79 |
      80 |     it('should return empty object on error', async () => {
    > 81 |       mockPool.query.mockRejectedValueOnce(new Error('DB error'));
         |                      ^
      82 |
      83 |       const memory = await recall('+972501234567');
      84 |       expect(memory).toEqual({});

      at Object.<anonymous> (tests/memoryService.test.js:81:22)

  ● Memory Service › updateCustomer() › should upsert customer with provided fields

    expect(received).toHaveBeenCalledWith(...expected)

    Matcher error: received value must be a mock or spy function

    Received has type:  function
    Received has value: [Function query]

       96 |       await updateCustomer(phone, fields);
       97 |
    >  98 |       expect(mockPool.query).toHaveBeenCalledWith(
          |                              ^
       99 |         expect.stringContaining('INSERT INTO customers (phone, first_name, city)'),
      100 |         [phone, 'John', 'Tel Aviv']
      101 |       );

      at Object.<anonymous> (tests/memoryService.test.js:98:30)

  ● Memory Service › updateCustomer() › should do nothing with empty fields object

    expect(received).not.toHaveBeenCalled()

    Matcher error: received value must be a mock or spy function

    Received has type:  function
    Received has value: [Function query]

      104 |     it('should do nothing with empty fields object', async () => {
      105 |       await updateCustomer('+972501234567', {});
    > 106 |       expect(mockPool.query).not.toHaveBeenCalled();
          |                                  ^
      107 |     });
      108 |
      109 |     it('should handle errors gracefully', async () => {

      at Object.<anonymous> (tests/memoryService.test.js:106:34)

  ● Memory Service › updateCustomer() › should handle errors gracefully

    TypeError: mockPool.query.mockRejectedValueOnce is not a function

      109 |     it('should handle errors gracefully', async () => {
      110 |       const error = new Error('DB error');
    > 111 |       mockPool.query.mockRejectedValueOnce(error);
          |                      ^
      112 |
      113 |       await expect(updateCustomer('+972501234567', { name: 'John' }))
      114 |         .rejects.toThrow('DB error');

      at Object.<anonymous> (tests/memoryService.test.js:111:22)

(node:20176) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/twilioService.test.js
  ● Twilio Service › sendWapp › should call Twilio client messages.create with correct parameters

    accountSid must start with AC

      23 |
      24 |   beforeEach(() => {
    > 25 |     mockTwilioClient = twilio();
         |                        ^
      26 |     jest.clearAllMocks();
      27 |   });
      28 |

      at Twilio.setAccountSid (node_modules/twilio/lib/base/BaseTwilio.js:82:23)
      at new Client (node_modules/twilio/lib/base/BaseTwilio.js:45:18)
      at new Twilio (node_modules/twilio/lib/rest/Twilio.js:33:9)
      at TwilioSDK (node_modules/twilio/lib/index.js:43:12)
      at Object.<anonymous> (tests/twilioService.test.js:25:24)

  ● Twilio Service › sendWapp › should handle errors gracefully

    accountSid must start with AC

      23 |
      24 |   beforeEach(() => {
    > 25 |     mockTwilioClient = twilio();
         |                        ^
      26 |     jest.clearAllMocks();
      27 |   });
      28 |

      at Twilio.setAccountSid (node_modules/twilio/lib/base/BaseTwilio.js:82:23)
      at new Client (node_modules/twilio/lib/base/BaseTwilio.js:45:18)
      at new Twilio (node_modules/twilio/lib/rest/Twilio.js:33:9)
      at TwilioSDK (node_modules/twilio/lib/index.js:43:12)
      at Object.<anonymous> (tests/twilioService.test.js:25:24)

  ● Twilio Service › smsFallback › should call Twilio client messages.create with correct parameters

    accountSid must start with AC

      23 |
      24 |   beforeEach(() => {
    > 25 |     mockTwilioClient = twilio();
         |                        ^
      26 |     jest.clearAllMocks();
      27 |   });
      28 |

      at Twilio.setAccountSid (node_modules/twilio/lib/base/BaseTwilio.js:82:23)
      at new Client (node_modules/twilio/lib/base/BaseTwilio.js:45:18)
      at new Twilio (node_modules/twilio/lib/rest/Twilio.js:33:9)
      at TwilioSDK (node_modules/twilio/lib/index.js:43:12)
      at Object.<anonymous> (tests/twilioService.test.js:25:24)

  ● Twilio Service › smsFallback › should handle errors gracefully

    accountSid must start with AC

      23 |
      24 |   beforeEach(() => {
    > 25 |     mockTwilioClient = twilio();
         |                        ^
      26 |     jest.clearAllMocks();
      27 |   });
      28 |

      at Twilio.setAccountSid (node_modules/twilio/lib/base/BaseTwilio.js:82:23)
      at new Client (node_modules/twilio/lib/base/BaseTwilio.js:45:18)
      at new Twilio (node_modules/twilio/lib/rest/Twilio.js:33:9)
      at TwilioSDK (node_modules/twilio/lib/index.js:43:12)
      at Object.<anonymous> (tests/twilioService.test.js:25:24)

(node:20177) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/pipelineFlow.test.js
  ● Console

    console.log
      ✅ Loaded 524 knowledge base entries

      at src/agentController.js:25:11

  ● Pipeline Flow Integration › handles multiple questions with vector search fallback

    TypeError: getHistory.mockResolvedValue is not a function

      22 |     
      23 |     // Mock memory service
    > 24 |     getHistory.mockResolvedValue({
         |                ^
      25 |       history: mockHistory,
      26 |       customer: { firstName: 'Test' }
      27 |     });

      at Object.<anonymous> (tests/pipelineFlow.test.js:24:16)

  ● Pipeline Flow Integration › handles zero vector search matches gracefully

    TypeError: getHistory.mockResolvedValue is not a function

      22 |     
      23 |     // Mock memory service
    > 24 |     getHistory.mockResolvedValue({
         |                ^
      25 |       history: mockHistory,
      26 |       customer: { firstName: 'Test' }
      27 |     });

      at Object.<anonymous> (tests/pipelineFlow.test.js:24:16)

(node:20173) ExperimentalWarning: VM Modules is an experimental feature and might change at any time
(Use `node --trace-warnings ...` to show where the warning was created)
FAIL tests/smartAnswer.test.js
  ● smartAnswer › filters out invalid messages

    TypeError: Cannot read properties of null (reading 'user')

      350 |   for (let i = history.length - 1; i >= 0; i--) {
      351 |     const exchange = history[i];
    > 352 |     if (exchange.user) {
          |                  ^
      353 |       const normalizedPrevQuestion = normalize(exchange.user);
      354 |       const similarity = calculateTextSimilarity(normalizedQuestion, normalizedPrevQuestion);
      355 |       

      at findSimilarPreviousQuestion (services/ragChain.js:352:18)
      at smartAnswer (services/ragChain.js:420:29)
      at Object.<anonymous> (tests/smartAnswer.test.js:39:11)

Test Suites: 5 failed, 5 total
Tests:       16 failed, 2 passed, 18 total
Snapshots:   0 total
Time:        3.014 s, estimated 4 s
Ran all test suites.
Test exit code: 1

=== Summary ===
❌ Some checks failed
Lint: 1, Test: 1
